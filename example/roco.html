<!DOCTYPE html>
<html>
    <head>
        <title>Train simulator</title>
        <script type="text/javascript" src="../src/trainsimulator.js"></script>
        <script type="text/javascript" src="../src/trainsimulatorui.js"></script>
        <script type="text/javascript" src="../src/builder.js"></script>
        <script type="text/javascript" src="../src/roco.js"></script>
    </head>
    <body>
        <h1>Train simulator TEST</h1>
        <canvas id="canvas" width="800" height="200"></canvas><br />
        <script type="text/javascript">
var schema = {
    'origin': {x: 500, y: 50, angle: 0},
    'pieces': [].concat(
        RocoPieces.straight200({name: 'top'}),
        RocoPieces.straight185(),
        RocoPieces.straight200(),
        RocoPieces.straight200(),
        RocoPieces.straight200(),
        RocoPieces.straight200(),
        RocoPieces.straight200(),
        RocoPieces.straight200(),
        RocoPieces.straight185(),
        RocoPieces.straight200(),
        
        RocoPieces.curve3right(),
        RocoPieces.curve3right(),
        RocoPieces.curve3right(),
        RocoPieces.curve3right(),
        RocoPieces.curve3right(),
        RocoPieces.curve3right({endPoint: 'sw1-1', name:'before-sw-1'}),
        
        RocoPieces.switchRight1('sw1', 'sw1-1', 'sw1-2', 'sw1-3'),
        RocoPieces.straight185({startPoint: 'sw1-2', name: 'bottom'}),
        RocoPieces.straight200(),
        RocoPieces.straight200(),
        RocoPieces.straight200(),
        RocoPieces.straight200(),
        RocoPieces.straight200(),
        RocoPieces.straight200(),
        RocoPieces.straight185({endPoint: 'sw2-2', name: 'bottom-end'}),
        RocoPieces.switchLeft2('sw2', 'sw2-1', 'sw2-2', 'sw2-3'),
        
        RocoPieces.curve3right({startPoint: 'sw2-1', name: 'after-sw-2'}),
        RocoPieces.curve3right(),
        RocoPieces.curve3right(),
        RocoPieces.curve3right(),
        RocoPieces.curve3right(),
        RocoPieces.curve3right({endPoint: 'origin'}),
        
        RocoPieces.counterCurveLeft({startPoint: 'sw1-3', name: 'middle'}),
        RocoPieces.straight200(),
        RocoPieces.straight200(),
        RocoPieces.straight200(),
        RocoPieces.straight200(),
        RocoPieces.straight200(),
        RocoPieces.straight200(),
        RocoPieces.counterCurveLeft({endPoint: 'sw2-3', name: 'middle-end'})
    )
};
var builder = new TrainSimulatorBuilder(document.getElementById('canvas'));
var tsui = builder.tsui;
builder.build(schema);
tsui.scale = 0.2;
tsui.trackWidth = 16;

var block = new Block();
block.addEntry(builder.tracks['bottom-end'], 100, 150);
block.addSignal(builder.tracks['bottom-end'], 100, 1);
block.addEntry(builder.tracks['middle-end'], 100, 150);
block.addSignal(builder.tracks['middle-end'], 100, 1);
block.addEntry(builder.tracks['bottom'], 100, 50);
block.addSignal(builder.tracks['bottom'], 100, -1);
block.addEntry(builder.tracks['middle'], 100, 50);
block.addSignal(builder.tracks['middle'], 100, -1);


var AutomaticTrain = function (size) {
    this.Train = Train;
    this.Train(size);
    var train = this;
    this.speed = 0;
    this.orderSpeed = 0;
    this.lastSpeed;
    this.elementSignal = {
        direction: 1,
        swaped: function (elm) {
            if (elm.signal && elm.direction === this.direction) {
                if (elm.signal() === 'stop') {
                    train.speed = 0;
                }
            }
        }
    };
    this.tick = function () {
        if (this.elementSignal.track) {
            this.elementSignal.track.removeElement(this.elementSignal);
        }
        if (this.orderSpeed >= 0) {
            this.elementSignal.direction = this.elementHead.direction;
        } else {
            this.elementSignal.direction = this.elementTail.direction;
        }
        this.move(this.speed);
        if (this.orderSpeed >= 0) {
            this.elementSignal.x = this.elementHead.x + 2 * this.orderSpeed;
            this.elementHead.track.addElement(this.elementSignal, this.elementHead.x - this.speed);
        } else {
            this.elementSignal.x = this.elementTail.x + 2 * this.orderSpeed;
            this.elementTail.track.addElement(this.elementSignal, this.elementTail.x - this.speed);
        }
        train.speed = train.orderSpeed;
    };
};

var train1 = new AutomaticTrain(500);
tsui.trains.push(train1);
train1.putOnTrack(builder.tracks['middle-end'], 100.5, 1);
train1.orderSpeed = 20;
train1.speed = 20;
var train2 = new AutomaticTrain(500);
tsui.trains.push(train2);
train2.putOnTrack(builder.tracks['bottom-end'], 5.5, 1);
train2.orderSpeed = -20;
train2.speed = -20;

builder.switches['sw1'].toggle();
tsui.trainSimulator.sortElements();
tsui.redraw();
tsui.trainSimulator.sortElements();


function tick() {
    train1.tick();
    train2.tick();
    tsui.trainSimulator.sortElements();
    tsui.redraw();
};

setInterval(tick, 100);
        </script>
        <!--button type="button" onclick="builder.switches['sw1'].toggle();builder.switches['sw2'].toggle();">Switch All</button-->
        <br />
        <!--button type="button" onclick="document.getElementById('speed1').value = parseInt(document.getElementById('speed1').value) - 1">Speed down</button>
        <input type="text" id="speed1" value="0" size="2" />
        <button type="button" onclick="document.getElementById('speed1').value = parseInt(document.getElementById('speed1').value) + 1">Speed up</button-->
        <br />
        <!--button type="button" onclick="document.getElementById('speed2').value = parseInt(document.getElementById('speed2').value) - 1">Speed down</button>
        <input type="text" id="speed2" value="0" size="2" />
        <button type="button" onclick="document.getElementById('speed2').value = parseInt(document.getElementById('speed2').value) + 1">Speed up</button-->
        
    </body>
</html>

